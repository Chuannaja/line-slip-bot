<div class="row g-4">
  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-primary text-white d-flex align-items-center">
        <i class="fa-solid fa-user-plus me-2"></i>
        <strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</strong>
      </div>
      <div class="card-body">
        <% if (query && query.success) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% } %>

        <form method="POST" action="/admin/users/add" class="needs-validation" novalidate>
          <div class="mb-3">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
              <input type="text" name="username" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô admin01" required>
              <div class="invalid-feedback">‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (Display name)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-regular fa-id-card"></i></span>
              <input type="text" name="display_name" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" required>
              <div class="invalid-feedback">‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</div>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
              <input type="password" name="password" id="password" class="form-control" minlength="8" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" required>
              <button type="button" class="btn btn-outline-secondary" id="togglePw" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                <i class="fa-regular fa-eye"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" id="genPw" title="‡∏™‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                <i class="fa-solid fa-bolt"></i> ‡∏™‡∏∏‡πà‡∏°
              </button>
              <div class="invalid-feedback">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</div>
            </div>
            <small class="text-muted">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏µ a‚Äìz, A‚ÄìZ, 0‚Äì9 ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</small>
          </div>
		  <!-- views/add-admin.ejs -->
			<div class="mb-3">
			  <label class="form-label">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Admin Level)</label>
			  <select class="form-select" name="admin_level" required>
				<option value="Full Control">Full Control</option>
				<option value="Admin">Admin</option>
				<option value="User">User</option>
			  </select>
			</div>
          <button class="btn btn-primary w-100 mt-3">
            <i class="fa-solid fa-plus me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏° User
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-success text-white d-flex align-items-center justify-content-between">
        <div>
          <i class="fa-solid fa-users me-2"></i><strong>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</strong>
        </div>
        <div class="w-50">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input type="text" id="filter" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ / ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á">
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-center" style="width:80px">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</th>
              <th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th> <!-- üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
              <th style="width:220px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
              <th style="width:120px" class="text-center">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th> <!-- üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
            </tr>
          </thead>
          <tbody id="userRows">
            <% (users || []).forEach(u => { %>
              <tr>
                <td class="text-center"><%= u.id %></td>
               <td class="fw-semibold"><%= u.username %></td>
               <td><%= u.display_name || '-' %></td>
                <td><span class="badge bg-light text-dark"><%= u.role || 'User' %></span></td> <!-- üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
                <td><%= new Date(u.created_at).toLocaleString('th-TH') %></td>
                <td class="text-center">
                  <% /* ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏°‡∏µ role = Full Control ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á */ %>
                  <% if (user && user.role === 'Full Control' && String(user.id) !== String(u.id)) { %>
                    <form method="POST" action="/admin/delete-user/<%= u.id %>"
                          onsubmit="return confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')"
                          class="d-inline">
                      <button type="submit" class="btn btn-danger btn-sm">
                        <i class="fa-solid fa-user-xmark"></i> ‡∏•‡∏ö
                      </button>
                    </form>
                  <% } else { %>
                   <span class="text-muted">‚Äî</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div class="card-footer small text-muted">
        ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= (users || []).length %> ‡∏Ñ‡∏ô
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';
  // Bootstrap validation
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(f => {
    f.addEventListener('submit', e => {
      if (!f.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
      f.classList.add('was-validated');
    }, false);
  });

  // Filter rows
  const filter = document.getElementById('filter');
  filter?.addEventListener('input', function () {
    const q = this.value.toLowerCase();
    document.querySelectorAll('#userRows tr').forEach(r => {
      const username = (r.children[1].innerText || '').toLowerCase();
      const display  = (r.children[2].innerText || '').toLowerCase();
      r.style.display = (username.includes(q) || display.includes(q)) ? '' : 'none';
    });
  });

  // Password tools
  const pw = document.getElementById('password');
  document.getElementById('togglePw')?.addEventListener('click', () => {
    if (!pw) return;
    pw.type = pw.type === 'password' ? 'text' : 'password';
  });
  document.getElementById('genPw')?.addEventListener('click', () => {
    if (!pw) return;
    pw.value = genPassword();
  });
  function genPassword(len = 12) {
    const lower='abcdefghijklmnopqrstuvwxyz', upper=lower.toUpperCase(), nums='0123456789', syms='!@#$%^&*()-_=+[]{};:,.?';
    const all = lower + upper + nums + syms;
    const pick = s => s[Math.floor(Math.random()*s.length)];
    let out = [pick(lower), pick(upper), pick(nums), pick(syms)];
    for (let i=out.length; i<len; i++) out.push(pick(all));
    for (let i=out.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [out[i],out[j]]=[out[j],out[i]]; }
    return out.join('');
  }
})();
</script>
