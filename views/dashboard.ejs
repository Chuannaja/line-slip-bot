<!-- ===== styles for dashboard ===== -->
<style>
  .card-filter .card-header{background:#f8fafc}
  .filter-chip{
    display:inline-flex;align-items:center;background:#f1f5f9;border-radius:999px;
    padding:4px 10px;margin:0 6px 6px 0;font-size:.875rem
  }
  .filter-chip .x{margin-left:6px;text-decoration:none;cursor:pointer}
  .table-responsive{max-height:65vh}
  .sticky-head thead th{position:sticky;top:0;background:#fff;z-index:2}
  .thumb{max-width:120px}
  .amount-cell{white-space:nowrap}
</style>

<!-- ===== FILTERS ===== -->
<div class="card card-filter shadow-sm mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div><i class="fas fa-filter me-2"></i><strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏Å‡∏£‡∏≠‡∏á</strong></div>
    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advFilters">
      ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    </button>
  </div>

  <div class="card-body">
    <!-- üü¢ ‡∏õ‡∏£‡∏±‡∏ö layout -->
    <form method="GET" action="/admin/dashboard" class="row g-3 align-items-end">
      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ -->
      <div class="col-md-3">
        <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
        <select name="payment_type" class="form-select">
          <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
          <option value="‡∏å‡∏≤‡∏õ‡∏ô‡∏Å‡∏¥‡∏à‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" <%= query.payment_type==='‡∏å‡∏≤‡∏õ‡∏ô‡∏Å‡∏¥‡∏à‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô'?'selected':'' %>>‡∏å‡∏≤‡∏õ‡∏ô‡∏Å‡∏¥‡∏à‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>
          <option value="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" <%= query.payment_type==='‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô'?'selected':'' %>>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>
          <option value="‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏≤‡∏ô" <%= query.payment_type==='‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏≤‡∏ô'?'selected':'' %>>‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏≤‡∏ô</option>
        </select>
      </div>

      <!-- ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
      <div class="col-md-4">
        <label class="form-label">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <div class="input-group">
          <input type="date" name="from" value="<%= query.from || '' %>" class="form-control">
          <span class="input-group-text">‡∏ñ‡∏∂‡∏á</span>
          <input type="date" name="to" value="<%= query.to || '' %>" class="form-control">
        </div>
      </div>

      <!-- ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á -->
      <div class="col-md-2">
        <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</label>
        <input type="text" name="id" value="<%= query.id || '' %>" class="form-control">
      </div>

      <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
      <div class="col-md-2">
        <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
        <select name="status" class="form-select">
          <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
          <option value="approved" <%= query.status==='approved'?'selected':'' %>>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
          <option value="rejected" <%= query.status==='rejected'?'selected':'' %>>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
          <option value="pending"  <%= query.status==='pending' ?'selected':'' %>>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
        </select>
      </div>
	  <div class="col-md-3 d-flex align-items-end">
		<button type="submit" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
		<a href="/admin/export-excel?<%= new URLSearchParams(query).toString() %>" class="btn btn-success ms-2">
		  üì§ Export Excel
		</a>
	  </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏° -->
      <div class="col-md-12 d-flex justify-content-end gap-2 mt-2">
        <a href="/admin/dashboard" class="btn btn-outline-secondary">
          <i class="fas fa-undo"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        </a>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </button>
      </div>
    </form>

    <!-- chips -->
    <div id="activeFilters" class="mt-3"></div>
  </div>
</div>

<!-- ===== RESULTS ===== -->
<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <i class="fas fa-list-ul me-2"></i><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</strong>
      <span class="badge bg-secondary ms-2"><%= payments.length %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
    </div>
    <div>
      <a href="/admin/summary" class="btn btn-sm btn-outline-primary"><i class="fas fa-chart-line me-1"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a>
    </div>
  </div>

  <% if (!payments.length) { %>
    <div class="p-4 text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
  <% } else { %>
    <div class="table-responsive">
      <table class="table table-hover align-middle sticky-head">
        <thead class="table-light">
          <tr>
            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
            <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
            <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th>‡∏™‡∏•‡∏¥‡∏õ</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th>
            <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody>
          <% payments.forEach(p => { %>
            <tr>
              <td><%= p.id %></td>
              <td><%= p.first_name || '' %></td>
              <td><%= p.last_name  || '' %></td>
              <td><%= p.address    || '' %></td>
              <td><%= p.phone      || '' %></td>

              <td class="amount-cell">
                <% if (p.amount && !isNaN(p.amount)) { %>
                  <%= parseFloat(p.amount).toFixed(2) %> ‡∏ö‡∏≤‡∏ó
                <% } else { %>‡πÑ‡∏°‡πà‡∏û‡∏ö<% } %>
              </td>

              <td>
                <% if (p.slip_url) { %>
                  <a href="<%= p.slip_url %>" target="_blank" rel="noopener">
                    <img src="<%= p.slip_url %>" class="img-thumbnail thumb" alt="slip">
                  </a>
                <% } else { %>-<% } %>
              </td>

              <td>
                <span class="badge <%= p.status==='approved'?'bg-success':p.status==='rejected'?'bg-danger':'bg-secondary' %>">
                  <%= p.status==='approved'?'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥':p.status==='rejected'?'‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥':'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' %>
                </span>
              </td>

              <td><%= (p.operator_name || p.status_changed_by || '-') %></td>

              <td>
                <span class="badge bg-info text-dark"><%= p.payment_type || '-' %></span>
              </td>

              <td>
                <% if (p.reject_reason) { %>
                  <button type="button"
                          class="btn btn-warning btn-sm btn-reason"
                          data-reason="<%- encodeURIComponent(p.reject_reason || '') %>">
                    <i class="fas fa-exclamation-circle"></i> ‡∏î‡∏π‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
                  </button>
                <% } else { %>-<% } %>
              </td>

              <td>
				  <form method="POST" action="/admin/update/<%= p.id %>" style="display:inline;">
					<input type="hidden" name="hidden_status" value="">
					<input type="hidden" name="reject_reason" id="reject_reason_<%= p.id %>">

					<div class="btn-group btn-group-sm" role="group">
					  <!-- ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
					  <button type="submit" name="status" value="approved" class="btn btn-success">
						‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
					  </button>
					  <!-- ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
					  <button type="button"
							  class="btn btn-danger btn-sm btn-open-reject"
							  data-id="<%= p.id %>">
						‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
					  </button>
					</div>
				  </form>

				  <!-- üü¢ ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
				  <a href="/admin/edit/<%= p.id %>" class="btn btn-warning">
					<i class="fas fa-edit"></i>
				  </a>

				  <!-- üü¢ ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö -->
				  <form method="POST" action="/admin/delete/<%= p.id %>" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?');" style="display:inline;">
					<button type="submit" class="btn btn-outline-danger">
					  <i class="fas fa-trash"></i>
					</button>
				  </form>
				</td>

            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>

<!-- ===== Reason View Modal (‡∏î‡∏π‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•) ===== -->
<div class="modal fade" id="reasonModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre id="reasonText" class="mb-0" style="white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>
</div>

<!-- ===== Reject Input Modal (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á) ===== -->
<div class="modal fade" id="rejectInputModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="rejectFormProxy" onsubmit="return false;">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-ban text-danger me-2"></i>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
      </div>
      <div class="modal-body">
        <textarea id="rejectInputText" class="form-control" rows="4" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." required></textarea>
        <div class="form-text">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-danger" id="confirmRejectBtn">
          <i class="fas fa-check"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ===== scripts ===== -->
<script>
(() => {
  // chips for active filters
  const q = <%- JSON.stringify(query || {}) %>;
  const labels = {
    payment_type:'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞', from:'‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà', to:'‡∏ñ‡∏∂‡∏á', id:'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà',
    first_name:'‡∏ä‡∏∑‡πà‡∏≠', address:'‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', phone:'‡πÄ‡∏ö‡∏≠‡∏£‡πå', status:'‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'
  };
  const el = document.getElementById('activeFilters');
  const parts = [];
  for (const k in labels) {
    const v = (q[k] || '').toString().trim();
    if (!v) continue;
    parts.push(`<span class="filter-chip">${labels[k]}: ${escapeHtml(v)}<a class="x" href="${rmParam(k)}" title="‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">&times;</a></span>`);
  }
  el.innerHTML = parts.join(' ');

  function rmParam(key){
    const u = new URL(window.location.href);
    u.searchParams.delete(key);
    return u.toString();
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ===== Modal Controls =====
  let currentId = null;

  // ‡πÄ‡∏õ‡∏¥‡∏î popup "‡∏î‡∏π‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•"
  document.querySelectorAll(".btn-reason").forEach(btn => {
    btn.addEventListener("click", e => {
      const reason = decodeURIComponent(btn.dataset.reason || "");
      document.getElementById("reasonText").innerText = reason;
      const modal = new bootstrap.Modal(document.getElementById("reasonModal"));
      modal.show();
    });
  });

  // ‡πÄ‡∏õ‡∏¥‡∏î popup "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
  document.querySelectorAll(".btn-open-reject").forEach(btn => {
    btn.addEventListener("click", e => {
      currentId = btn.dataset.id;
      document.getElementById("rejectInputText").value = "";
      const modal = new bootstrap.Modal(document.getElementById("rejectInputModal"));
      modal.show();
    });
  });

  // ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  document.getElementById("confirmRejectBtn").addEventListener("click", e => {
    const reason = document.getElementById("rejectInputText").value.trim();
    if (!reason) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•"); return; }
    if (currentId) {
      // üü¢ ‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏•‡∏á hidden input
      document.getElementById("reject_reason_" + currentId).value = reason;
      // üü¢ ‡πÉ‡∏™‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ rejected ‡∏•‡∏á hidden input
      let hidden = document.querySelector(`form[action='/admin/update/${currentId}'] input[name='hidden_status']`);
		if (hidden) {
		  hidden.name = "status";   // üü¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ field ‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
		  hidden.value = "rejected";
		}

      // üü¢ submit form
      document.querySelector(`form[action='/admin/update/${currentId}']`).submit();
    }
  });
})();
</script>
